<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html>
	<head>
		<title>jGen Map Editor</title>
		<link rel="stylesheet" type="text/css" href="css/stylesheet.css" />
		<script type="text/javascript" src="scripts/oop.js"></script>
		<script type="text/javascript" src="scripts/string.js"></script>
		<script type="text/javascript" src="scripts/html.js"></script>
		<script type="text/javascript" src="scripts/math.js"></script>
		<script type="text/javascript" src="scripts/map.js"></script>
		<script type="text/javascript" src="scripts/editor.js"></script>
		
		<script type="text/javascript">
			var TEngine = Class.create({
				callback: null,
				eventHandler: null,
				gameState: {
					height: 0,
					keys: {},
					mouse: {},
					metaKey: false
				},
				constructor: function(oViewPort, fCallback) {
					var oThis = this;
					this.viewPort = oViewPort;
					this.callback = fCallback;
					this.eventHandler = function(oEvent) {
						// update metakey state
						oThis.gameState.metaKey = oEvent.metaKey;
						
						if (oEvent.type == 'change') {
							if (oEvent.target.name == 'heightSlider') oThis.gameState.height = parseInt(oEvent.target.value, 10);
						}
						
						else if (oEvent.type == 'keydown') oThis.gameState.keys[oEvent.keyCode] = true;
						else if (oEvent.type == 'keyup') oThis.gameState.keys[oEvent.keyCode] = false;
						else if (oEvent.type == 'mousedown') oThis.gameState.mouse.down = true;
						else if (oEvent.type == 'mouseup') oThis.gameState.mouse.down = false;
						else if (oEvent.type == 'mousemove') {
							oThis.gameState.mouse.x = (oEvent.clientX - oThis.viewPort.offsetLeft);
							oThis.gameState.mouse.y = (oEvent.clientY - oThis.viewPort.offsetTop);
						}
					};
				},
				start: function(oViewPort) {
					var oThis = this;
					document.addEventListener('change', this.eventHandler, false);
					document.addEventListener('keydown', this.eventHandler, false);
					document.addEventListener('keyup', this.eventHandler, false);
					this.viewPort.addEventListener('mousemove', this.eventHandler, false);
					this.viewPort.addEventListener('mousedown', this.eventHandler, false);
					this.viewPort.addEventListener('mouseup', this.eventHandler, false);
					window.top.testInterval = function() {
						oThis.callback.call(oThis, oThis.gameState);
					}
					for (var c = 0; c < 1; c++) {
						setInterval(window.top.testInterval, 0);
					}
				}
			});
			
		</script>
		
		<script type="text/javascript">
			function start() {
				var oEditor = new TEditor();
				oEditor.loadLibrary('library/library.xml', function() {
					this.renderPalette(document.querySelector('.palette'));
					this.renderWorkspace(document.querySelector('.viewPort'));
					
					var iHeight = 0;
					var iScrollX = iNewScrollX = 0;
					var iScrollY = iNewScrollY = 0;
					var iCaptureX = iCaptureY = -1;
					
					window.addEventListener('resize', function() {
						oEditor.map.resizeViewPort(oEditor.map.viewPort.offsetWidth, oEditor.map.viewPort.offsetHeight);
						oEditor.map.render(iScrollX, iScrollY);
					}, false);
						
					var iSecond = (new Date()).getSeconds();
					var iCounter = 0;
					var oFPSWindow = document.querySelector('.fpsWindow');
						
					(new TEngine(oEditor.map.viewPort.parentNode, function(oGameState) {
					
						iCounter++;
					
						if (oGameState.mouse.down) {
							if ((oGameState.metaKey) && (iCaptureX == -1) && (iCaptureY == -1)) {
								iCaptureX = oGameState.mouse.x + iScrollX;
								iCaptureY = oGameState.mouse.y + iScrollY;
							} else if (oGameState.metaKey) {
								iNewScrollX = (iCaptureX - oGameState.mouse.x);
								iNewScrollY = (iCaptureY - oGameState.mouse.y);
								if ((iNewScrollX != iScrollX) || (iNewScrollY != iScrollY)) {
									oEditor.map.render(iNewScrollX, iNewScrollY);
									iScrollX = iNewScrollX;
									iScrollY = iNewScrollY;
								}
							} else if (oEditor.selectedObject) {
								var a = oEditor.map.screen2map(
									oGameState.mouse.x,
									oGameState.mouse.y,
									iScrollX,
									iScrollY
								);
								
								var sIndex = a[1] + '.' + a[0];
								oEditor.map.objects[sIndex] = (oEditor.selectedObject.name);
								if (oEditor.map.mapData[sIndex]) {
									oEditor.map.mapData[sIndex].parentNode.removeChild(oEditor.map.mapData[sIndex]);
									delete(oEditor.map.mapData[sIndex]);
								}
								
								oEditor.map.render(iScrollX, iScrollY);
							}
						} else {  
							iCaptureX = -1;
							iCaptureY = -1;
						}
						
						/*
						if (iHeight != oGameState.height) {
							iHeight = oGameState.height;
							for (var sIndex in oEditor.map.mapData) {
								var oTile = oEditor.map.mapData[sIndex];
								if (oTile.offsetHeight == 32) {
									oTile.style.opacity = iHeight / 100;
								}
							}
							 
						}
						*/
						var iNewSecond = (new Date()).getSeconds();
						if (iNewSecond != iSecond) {
							iSecond = iNewSecond;
							oFPSWindow.innerHTML = 'FPS: ' + iCounter;
							iCounter = 0;
						}
					
					})).start();
				});
			}
		</script>
	</head>
	<body onload="start();">
		<div class="palette">
			
		</div>
		<div class="viewPort">
			<div class="fpsWindow"></div>
		</div>
		<div class="rightPanel">
			<input name="heightSlider" type="range" min="0" max="100" step="1" value="0" />
		</div>
	</body>
</html>
